<!DOCTYPE html>
<html>
<head>
  <title>Almandala</title>
  <link rel="stylesheet" type="text/css" href="./css/style.css" />
  <script type="text/javascript" src="./js/paper-core.min.js"></script>
  <script type="text/javascript">
  window.onload = function() {
    var center = [0, 0];
    var calcRadius = function() {
      return Math.min(window.innerWidth / 2, window.innerHeight / 2) * 0.85;
    }
    var radius = calcRadius();
    paper.install(window);

    var canvas = document.getElementById('main');
    paper.setup(canvas);
    view.center = [0,0];
    var originViewport = view.matrix.clone();

    var guides = new Layer();
    var circle = new Path.Circle({
      center: center,
      radius: radius,
      strokeColor: '#c0c0c0',
    });

    var n_lines = 10;
    for(var i = 0; i < n_lines; i++) {
      var line = new Path.Line({
        from: [center[0] - radius, center[1]],
        to: [center[0], center[1]],
        strokeColor: '#c0c0c0'
      });
      line.rotate(i / n_lines * 360.0, center);
    }

    var draw = new Layer();
    var preview = new Layer();

    var drawingPath;
    var singleDrawer = {
      preview: function(event) {
        new Path.Circle({
          center: [event.point.x, event.point.y],
          radius: 1,
          fillColor: 'black',
        });
      },
      onMouseDown: function(event) {
        drawingPath = new Path();
        drawingPath.strokeColor = 'black';
        drawingPath.add(event.point);
      },
      onMouseDrag: function(event) {
        drawingPath.add(event.point);
      }
    };

    var drawingPaths;
    var getClonedPoints = function(point) {
      var copy = new Matrix(1,0,0,1,0,0);
      var res = [];
      for(var i = 0; i < n_lines; i++) {
        res.push(copy.transform(point));
        copy.rotate(360.0 / n_lines, center);
      }
      return res;
    }

    var cloneDrawer = {
      preview: function(event) {
        var points = getClonedPoints(event.point);
        var copy = new Matrix(1,0,0,1,0,0);
        for(var i = 0; i < n_lines; i++) {
          new Path.Circle({
            center: points[i],
            radius: 1,
            fillColor: (i == 0 ? 'black' : '#999'),
          });
        }
      },
      onMouseDown: function(event) {
        var points = getClonedPoints(event.point);
        drawingPaths = [];
        for(var i = 0; i < n_lines; i++) {
          var drawingPath = new Path();
          drawingPath.strokeColor = 'black';
          drawingPath.add(points[i]);
          drawingPaths.push(drawingPath);
        }
      },
      onMouseDrag: function(event) {
        var points = getClonedPoints(event.point);
        for(var i = 0; i < n_lines; i++) {
          drawingPaths[i].add(points[i]);
        }
      }
    };

    // var drawer = singleDrawer;
    var drawer = cloneDrawer;

    var pencil = new Tool();
    pencil.onMouseMove = function(event) {
      preview.removeChildren();
      if(circle.contains(event.point)) {
        canvas.classList.add('nocursor');
        preview.activate();
        drawer.preview(event);
      } else {
        canvas.classList.remove('nocursor');
      }
    };
    pencil.onMouseDown = function(event) {
      draw.activate();
      drawer.onMouseDown(event);
    };
    pencil.onMouseDrag = function(event) {
      drawer.onMouseDrag(event);
    };

    var nop = new Tool();
    nop.activate();

    document.getElementById("pencil").onclick = function() {
      (tool == pencil ? nop : pencil).activate();
    };

    pencil.activate();
    // window.setInterval(function(){ guides.rotate(1, center); draw.rotate(1, center); }, 300);

    window.onresize = function() {
      view.matrix = originViewport.clone().scale(calcRadius() / radius);
    };
  }
  </script>
</head>
<body>
  <button id="pencil">draw</button>
  <canvas id="main" resize>
  </canvas>
</body>
</html>
